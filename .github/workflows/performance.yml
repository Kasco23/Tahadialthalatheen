name: Performance
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [minimal]

permissions:
  contents: read
  statuses: write # allows lighthouse-ci to post a status check

jobs:
  lhci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Wait for Netlify preview to be ready
      - name: Await Netlify preview
        id: netlify
        uses: jakepartusch/wait-for-netlify-action@v1
        with:
          site_name: ${{ vars.NETLIFY_PROJECT_ID }} # requires NETLIFY_AUTH_TOKEN in secrets

      - name: Install Node & pnpm
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - run: npm i -g @lhci/cli

      - name: Run Lighthouse CI
        run: |
          lhci autorun \
            --collect.url=${{ steps.netlify.outputs.url }} \
            --upload.target=temporary-public-storage
